# Fluxo de Descoberta - Atual vs Esperado

## ‚ùå **FLUXO ATUAL (QUEBRADO)**

```
1. Usu√°rio digita path manual ‚Üí C:\Users\...
2. Clica "Adicionar Locais" ‚Üí Salva string no AppState
3. Clica "Iniciar Descoberta"
   ‚Üí startDiscovery()
   ‚Üí _validateDirectories() - valida apenas caracteres
   ‚Üí Procura handle em window.directoryHandles - N√ÉO ENCONTRA
   ‚Üí _scanDirectory() recebe string
   ‚Üí Detecta string path ‚Üí files = [] (vazio)
   ‚Üí 0 arquivos descobertos
```

**Problema:** Handles s√£o salvos pelo nome do diret√≥rio, mas buscados pelo path completo

## ‚úÖ **FLUXO ESPERADO (CORRETO)**

```
1. Usu√°rio clica "Localizar Pasta"
2. browseDirectory() ‚Üí Obt√©m handle real
3. Salva handle com identificador √∫nico
4. Clica "Iniciar Descoberta"
   ‚Üí startDiscovery()
   ‚Üí Recupera handle salvo
   ‚Üí _scanDirectory() recebe objeto com handle
   ‚Üí _realDirectoryScan() usa handle
   ‚Üí Arquivos reais descobertos
```

## üîç **PONTOS DE FALHA IDENTIFICADOS**

### **1. Salvamento de Handles**
- **Atual:** `window.directoryHandles.set(accessResult.name, handle)`
- **Problema:** Nome pode ser gen√©rico como "Documents"
- **Solu√ß√£o:** Usar ID √∫nico ou path completo

### **2. Recupera√ß√£o de Handles**
- **Atual:** `window.directoryHandles.get(directory)`
- **Problema:** `directory` √© path completo, n√£o nome
- **Solu√ß√£o:** Sistema de mapeamento path ‚Üî handle

### **3. Valida√ß√£o de Diret√≥rios**
- **Atual:** Valida apenas caracteres v√°lidos
- **Problema:** N√£o verifica se tem handle associado
- **Solu√ß√£o:** Validar presen√ßa de handle

### **4. Interface Confusa**
- **Atual:** Campo de texto sugere entrada manual
- **Problema:** Entrada manual n√£o funciona
- **Solu√ß√£o:** Tornar campo readonly ou remover

## üìê **ARQUITETURA NECESS√ÅRIA**

```javascript
HandleManager {
  handles: Map<id, {handle, path, name}>
  
  register(handle, metadata) ‚Üí id
  getByPath(path) ‚Üí {handle, metadata}
  getById(id) ‚Üí {handle, metadata}
  list() ‚Üí [{id, path, name}]
}
```

## üéØ **RESULTADO ESPERADO**

1. **"Localizar Pasta"** ‚Üí Sempre funciona com dados reais
2. **"Adicionar Locais"** ‚Üí Desabilitado ou com aviso claro
3. **Descoberta** ‚Üí Sempre encontra arquivos quando h√° handles
4. **Interface** ‚Üí Mostra quais diret√≥rios t√™m acesso real

## üö® **ERROS CR√çTICOS RECORRENTES**

### **Padr√£o de Falhas Identificado:**
1. **Servidor offline** - M√∫ltiplas tentativas de iniciar porta 8000
2. **Scripts com erros** - Modifica√ß√µes sem teste de sintaxe
3. **Depend√™ncias quebradas** - KC.xxx undefined
4. **Integra√ß√£o falha** - Componentes n√£o se comunicam

### **Protocolo de Preven√ß√£o:**
- SEMPRE matar processos antigos antes de iniciar servidor
- SEMPRE verificar console por erros JavaScript
- SEMPRE testar funcionalidade ap√≥s cada mudan√ßa
- PARAR se qualquer componente mostrar 'undefined'

### **Checkpoint Obrigat√≥rio:**
```bash
1. pkill -f "python -m http.server"
2. python -m http.server 8000
3. Abrir http://localhost:8000
4. F12 ‚Üí Console deve estar limpo
5. Testar funcionalidade espec√≠fica
6. S√ì AVAN√áAR se tudo funcionar
```

## ‚ö†Ô∏è **REGRAS DE PARADA**

### **PARAR IMEDIATAMENTE SE:**
- Servidor n√£o responder na primeira tentativa
- Console mostrar qualquer erro JavaScript  
- Qualquer KC.xxx retornar 'undefined'
- Funcionalidade n√£o responder como esperado

### **NUNCA MARCAR COMO CONCLU√çDO SEM:**
- Servidor acess√≠vel e funcional
- Console completamente limpo
- Teste manual bem-sucedido
- Confirma√ß√£o de que n√£o quebrou funcionalidades existentes