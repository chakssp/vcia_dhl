<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Visualiza√ß√£o de Grafo de Conhecimento</title>
    
    <!-- vis.js para visualiza√ß√£o de grafos -->
    <script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
    <link href="https://unpkg.com/vis-network@9.1.2/dist/dist/vis-network.min.css" rel="stylesheet">
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .graph-container {
            display: flex;
            gap: 20px;
            height: 600px;
        }
        #mynetwork {
            flex: 1;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .sidebar {
            width: 300px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            overflow-y: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background: #3b82f6;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .node-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
        }
        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 1000;
        }
        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîó Visualiza√ß√£o de Grafo de Conhecimento</h1>
            <p>Visualiza√ß√£o interativa estilo Obsidian das conex√µes entre arquivos, categorias, entidades e conceitos.</p>
        </div>

        <div class="controls">
            <button onclick="loadLocalData()">üìÅ Carregar Dados Locais</button>
            <button onclick="loadMCPMemory()">üß† Carregar MCP Memory</button>
            <button onclick="loadQdrantData()">üîç Carregar Qdrant</button>
            <button onclick="combineAllSources()">üîÑ Combinar Todas as Fontes</button>
            <button onclick="exportGraph()">üíæ Exportar Grafo</button>
            
            <div class="filter-group">
                <label>
                    <input type="checkbox" id="showFiles" checked onchange="applyFilters()"> Arquivos
                </label>
                <label>
                    <input type="checkbox" id="showCategories" checked onchange="applyFilters()"> Categorias
                </label>
                <label>
                    <input type="checkbox" id="showEntities" checked onchange="applyFilters()"> Entidades
                </label>
                <label>
                    <input type="checkbox" id="showConcepts" checked onchange="applyFilters()"> Conceitos
                </label>
            </div>
            
            <div class="filter-group">
                <label>Relev√¢ncia m√≠nima:</label>
                <input type="range" id="relevanceFilter" min="0" max="100" value="0" onchange="applyFilters()">
                <span id="relevanceValue">0%</span>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #3b82f6;"></div>
                <span>Arquivos</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #10b981;"></div>
                <span>Categorias</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f59e0b;"></div>
                <span>Entidades</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #8b5cf6;"></div>
                <span>Conceitos MCP</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ef4444;"></div>
                <span>Pontos Qdrant</span>
            </div>
        </div>

        <div class="graph-container">
            <div id="mynetwork" style="position: relative;">
                <div class="loading" id="loading">Carregando...</div>
            </div>
            
            <div class="sidebar">
                <div class="stats" id="stats">
                    <h3>üìä Estat√≠sticas</h3>
                    <p>N√≥s: <span id="nodeCount">0</span></p>
                    <p>Conex√µes: <span id="edgeCount">0</span></p>
                    <p>Densidade: <span id="density">0.00</span></p>
                    <p>Clusters: <span id="clusters">0</span></p>
                </div>
                
                <div class="node-details" id="nodeDetails">
                    <h3>üìå Detalhes do N√≥</h3>
                    <p>Selecione um n√≥ para ver detalhes...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dados globais
        let network = null;
        let nodes = new vis.DataSet();
        let edges = new vis.DataSet();
        let allNodes = [];
        let allEdges = [];

        // Cores por tipo
        const nodeColors = {
            file: '#3b82f6',
            category: '#10b981',
            entity: '#f59e0b',
            concept: '#8b5cf6',
            qdrant: '#ef4444'
        };

        // Inicializar rede
        function initNetwork() {
            const container = document.getElementById('mynetwork');
            const data = { nodes: nodes, edges: edges };
            
            const options = {
                nodes: {
                    shape: 'dot',
                    size: 20,
                    font: {
                        size: 14,
                        color: '#333'
                    },
                    borderWidth: 2,
                    shadow: true
                },
                edges: {
                    width: 2,
                    color: { color: '#666', highlight: '#3b82f6' },
                    smooth: { type: 'continuous' },
                    arrows: { to: { enabled: true, scaleFactor: 0.5 } }
                },
                physics: {
                    enabled: true,
                    forceAtlas2Based: {
                        gravitationalConstant: -50,
                        centralGravity: 0.01,
                        springLength: 100,
                        springConstant: 0.08,
                        damping: 0.4,
                        avoidOverlap: 1
                    },
                    solver: 'forceAtlas2Based'
                },
                interaction: {
                    hover: true,
                    hoverConnectedEdges: true,
                    tooltipDelay: 200
                }
            };
            
            network = new vis.Network(container, data, options);
            
            // Eventos
            network.on("click", function(params) {
                if (params.nodes.length > 0) {
                    showNodeDetails(params.nodes[0]);
                }
            });
            
            network.on("doubleClick", function(params) {
                if (params.nodes.length > 0) {
                    const node = nodes.get(params.nodes[0]);
                    if (node.type === 'file') {
                        alert(`Abrindo arquivo: ${node.label}`);
                    }
                }
            });
        }

        // Carregar dados locais simulados
        function loadLocalData() {
            showLoading(true);
            
            // Limpar dados anteriores
            nodes.clear();
            edges.clear();
            
            // Adicionar arquivos de exemplo
            const files = [
                { id: 'file1', label: 'Projeto IA.md', relevance: 85, categories: ['IA/ML', 'Projetos'] },
                { id: 'file2', label: 'Notas Reuni√£o.md', relevance: 65, categories: ['Reuni√µes'] },
                { id: 'file3', label: 'Framework RAG.md', relevance: 90, categories: ['IA/ML', 'Arquitetura'] },
                { id: 'file4', label: 'Decis√µes Q1.md', relevance: 75, categories: ['Decis√µes', 'Planejamento'] },
                { id: 'file5', label: 'Aprendizados 2024.md', relevance: 80, categories: ['Insights'] }
            ];
            
            // Adicionar categorias
            const categories = ['IA/ML', 'Projetos', 'Reuni√µes', 'Arquitetura', 'Decis√µes', 'Planejamento', 'Insights'];
            
            // Adicionar n√≥s de arquivos
            files.forEach(file => {
                nodes.add({
                    id: file.id,
                    label: file.label,
                    type: 'file',
                    color: nodeColors.file,
                    size: 20 + (file.relevance / 5),
                    title: `Relev√¢ncia: ${file.relevance}%`,
                    relevance: file.relevance
                });
            });
            
            // Adicionar n√≥s de categorias
            categories.forEach(cat => {
                nodes.add({
                    id: `cat_${cat}`,
                    label: cat,
                    type: 'category',
                    color: nodeColors.category,
                    size: 25,
                    shape: 'square'
                });
            });
            
            // Conectar arquivos √†s categorias
            files.forEach(file => {
                file.categories.forEach(cat => {
                    edges.add({
                        from: file.id,
                        to: `cat_${cat}`,
                        label: 'pertence a',
                        color: { color: '#ccc' }
                    });
                });
            });
            
            // Adicionar algumas entidades extra√≠das
            const entities = [
                { id: 'ent1', label: 'GPT-4', type: 'entity', relatedTo: ['file1', 'file3'] },
                { id: 'ent2', label: 'Q1 2025', type: 'entity', relatedTo: ['file4'] },
                { id: 'ent3', label: 'Qdrant', type: 'entity', relatedTo: ['file3'] }
            ];
            
            entities.forEach(entity => {
                nodes.add({
                    id: entity.id,
                    label: entity.label,
                    type: 'entity',
                    color: nodeColors.entity,
                    size: 15,
                    shape: 'diamond'
                });
                
                entity.relatedTo.forEach(fileId => {
                    edges.add({
                        from: entity.id,
                        to: fileId,
                        label: 'mencionado em',
                        color: { color: '#fbbf24' },
                        dashes: true
                    });
                });
            });
            
            // Salvar dados completos
            allNodes = nodes.get();
            allEdges = edges.get();
            
            updateStats();
            showLoading(false);
        }

        // Carregar dados do MCP Memory (simulado)
        function loadMCPMemory() {
            showLoading(true);
            
            // Simular conceitos do MCP Memory
            const concepts = [
                { id: 'mcp1', label: 'Arquitetura de Software', relations: ['file3'] },
                { id: 'mcp2', label: 'Machine Learning', relations: ['file1', 'file3'] },
                { id: 'mcp3', label: 'Tomada de Decis√£o', relations: ['file4'] },
                { id: 'mcp4', label: 'Gest√£o de Conhecimento', relations: ['file5'] }
            ];
            
            concepts.forEach(concept => {
                if (!nodes.get(concept.id)) {
                    nodes.add({
                        id: concept.id,
                        label: concept.label,
                        type: 'concept',
                        color: nodeColors.concept,
                        size: 20,
                        shape: 'ellipse',
                        title: 'Conceito do MCP Memory'
                    });
                    
                    concept.relations.forEach(fileId => {
                        if (nodes.get(fileId)) {
                            edges.add({
                                from: concept.id,
                                to: fileId,
                                label: 'relacionado',
                                color: { color: '#8b5cf6' },
                                width: 3
                            });
                        }
                    });
                }
            });
            
            // Adicionar conex√µes entre conceitos
            edges.add({
                from: 'mcp1',
                to: 'mcp2',
                label: 'integra com',
                color: { color: '#8b5cf6' },
                width: 2
            });
            
            allNodes = nodes.get();
            allEdges = edges.get();
            
            updateStats();
            showLoading(false);
            alert('Dados do MCP Memory carregados (simula√ß√£o)');
        }

        // Carregar dados do Qdrant (simulado)
        function loadQdrantData() {
            showLoading(true);
            
            // Simular pontos do Qdrant
            const qdrantPoints = [
                { id: 'qdr1', label: 'Cluster IA', similarity: 0.92, related: ['file1', 'file3'] },
                { id: 'qdr2', label: 'Cluster Decis√µes', similarity: 0.87, related: ['file4', 'file5'] },
                { id: 'qdr3', label: 'Cluster Projetos', similarity: 0.85, related: ['file1', 'file2'] }
            ];
            
            qdrantPoints.forEach(point => {
                if (!nodes.get(point.id)) {
                    nodes.add({
                        id: point.id,
                        label: point.label,
                        type: 'qdrant',
                        color: nodeColors.qdrant,
                        size: 30,
                        shape: 'star',
                        title: `Similaridade: ${(point.similarity * 100).toFixed(1)}%`
                    });
                    
                    point.related.forEach(fileId => {
                        if (nodes.get(fileId)) {
                            edges.add({
                                from: point.id,
                                to: fileId,
                                label: `sim: ${point.similarity.toFixed(2)}`,
                                color: { color: '#ef4444' },
                                width: point.similarity * 5
                            });
                        }
                    });
                }
            });
            
            allNodes = nodes.get();
            allEdges = edges.get();
            
            updateStats();
            showLoading(false);
            alert('Dados do Qdrant carregados (simula√ß√£o)');
        }

        // Combinar todas as fontes
        function combineAllSources() {
            loadLocalData();
            setTimeout(() => loadMCPMemory(), 500);
            setTimeout(() => loadQdrantData(), 1000);
        }

        // Aplicar filtros
        function applyFilters() {
            const showFiles = document.getElementById('showFiles').checked;
            const showCategories = document.getElementById('showCategories').checked;
            const showEntities = document.getElementById('showEntities').checked;
            const showConcepts = document.getElementById('showConcepts').checked;
            const minRelevance = parseInt(document.getElementById('relevanceFilter').value);
            
            document.getElementById('relevanceValue').textContent = minRelevance + '%';
            
            // Filtrar n√≥s
            const filteredNodes = allNodes.filter(node => {
                if (node.type === 'file' && !showFiles) return false;
                if (node.type === 'category' && !showCategories) return false;
                if (node.type === 'entity' && !showEntities) return false;
                if (node.type === 'concept' && !showConcepts) return false;
                if (node.relevance && node.relevance < minRelevance) return false;
                return true;
            });
            
            const nodeIds = filteredNodes.map(n => n.id);
            
            // Filtrar arestas
            const filteredEdges = allEdges.filter(edge => {
                return nodeIds.includes(edge.from) && nodeIds.includes(edge.to);
            });
            
            // Atualizar visualiza√ß√£o
            nodes.clear();
            edges.clear();
            nodes.add(filteredNodes);
            edges.add(filteredEdges);
            
            updateStats();
        }

        // Mostrar detalhes do n√≥
        function showNodeDetails(nodeId) {
            const node = nodes.get(nodeId);
            if (!node) return;
            
            let html = `<h3>üìå ${node.label}</h3>`;
            html += `<p><strong>Tipo:</strong> ${node.type}</p>`;
            
            if (node.relevance) {
                html += `<p><strong>Relev√¢ncia:</strong> ${node.relevance}%</p>`;
            }
            
            // Conex√µes
            const connections = edges.get().filter(e => e.from === nodeId || e.to === nodeId);
            if (connections.length > 0) {
                html += `<p><strong>Conex√µes:</strong> ${connections.length}</p>`;
                html += '<ul>';
                connections.forEach(conn => {
                    const otherId = conn.from === nodeId ? conn.to : conn.from;
                    const otherNode = nodes.get(otherId);
                    if (otherNode) {
                        html += `<li>${otherNode.label} (${conn.label || 'conectado'})</li>`;
                    }
                });
                html += '</ul>';
            }
            
            document.getElementById('nodeDetails').innerHTML = html;
        }

        // Atualizar estat√≠sticas
        function updateStats() {
            const nodeCount = nodes.length;
            const edgeCount = edges.length;
            const density = nodeCount > 1 ? (2 * edgeCount / (nodeCount * (nodeCount - 1))).toFixed(3) : 0;
            
            document.getElementById('nodeCount').textContent = nodeCount;
            document.getElementById('edgeCount').textContent = edgeCount;
            document.getElementById('density').textContent = density;
            
            // Detectar clusters (simplificado)
            const clusters = detectClusters();
            document.getElementById('clusters').textContent = clusters;
        }

        // Detectar clusters (implementa√ß√£o simplificada)
        function detectClusters() {
            // Aqui seria implementado um algoritmo real de detec√ß√£o de comunidades
            // Por ora, vamos contar tipos √∫nicos como "clusters"
            const types = new Set(nodes.get().map(n => n.type));
            return types.size;
        }

        // Exportar grafo
        function exportGraph() {
            const data = {
                nodes: nodes.get(),
                edges: edges.get(),
                metadata: {
                    exportDate: new Date().toISOString(),
                    nodeCount: nodes.length,
                    edgeCount: edges.length,
                    types: [...new Set(nodes.get().map(n => n.type))]
                }
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `knowledge-graph-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Mostrar/esconder loading
        function showLoading(show) {
            const loadingEl = document.getElementById('loading');
            if (loadingEl) {
                loadingEl.style.display = show ? 'block' : 'none';
            }
        }

        // Inicializar ao carregar p√°gina
        window.onload = function() {
            initNetwork();
            loadLocalData(); // Carregar dados iniciais
        };
    </script>
</body>
</html>