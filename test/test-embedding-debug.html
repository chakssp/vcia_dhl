<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug de Embeddings</title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        body {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-output {
            background: var(--bg-tertiary);
            border-radius: var(--border-radius);
            padding: 15px;
            font-family: monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status-ok { color: var(--success-color); }
        .status-error { color: var(--danger-color); }
        button {
            margin: 5px;
            padding: 10px 20px;
        }
    </style>
</head>
<body>
    <h1>üîç Debug de Embeddings - Diagn√≥stico Detalhado</h1>
    
    <!-- Teste B√°sico -->
    <div class="test-section">
        <h2>1. Teste B√°sico de Embedding</h2>
        <button onclick="testBasicEmbedding()">Testar Embedding Simples</button>
        <div id="basic-output" class="test-output">Aguardando teste...</div>
    </div>

    <!-- Teste de Conte√∫do Real -->
    <div class="test-section">
        <h2>2. Teste com Conte√∫do de Arquivo</h2>
        <button onclick="testFileContent()">Testar com Arquivo Real</button>
        <div id="file-output" class="test-output">Aguardando teste...</div>
    </div>

    <!-- Teste Direto com Ollama -->
    <div class="test-section">
        <h2>3. Teste Direto com Ollama API</h2>
        <button onclick="testOllamaDirect()">Testar API Diretamente</button>
        <div id="ollama-output" class="test-output">Aguardando teste...</div>
    </div>

    <!-- Verificar Configura√ß√£o -->
    <div class="test-section">
        <h2>4. Verificar Configura√ß√£o do Servi√ßo</h2>
        <button onclick="checkServiceConfig()">Verificar Configura√ß√£o</button>
        <div id="config-output" class="test-output">Aguardando verifica√ß√£o...</div>
    </div>

    <!-- Scripts -->
    <script src="../js/core/EventBus.js"></script>
    <script src="../js/core/AppState.js"></script>
    <script src="../js/core/Logger.js"></script>
    <script src="../js/services/EmbeddingService.js"></script>

    <script>
        const KC = window.KnowledgeConsolidator;

        function log(elementId, message, isError = false) {
            const output = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = isError ? 'status-error' : '';
            output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }

        // 1. Teste b√°sico
        async function testBasicEmbedding() {
            const outputId = 'basic-output';
            document.getElementById(outputId).innerHTML = '';
            
            log(outputId, 'Iniciando teste b√°sico...');
            
            try {
                // Teste 1: Texto muito simples
                const text1 = "teste";
                log(outputId, `Teste 1: "${text1}"`);
                const emb1 = await KC.EmbeddingService.generateEmbedding(text1);
                log(outputId, `Resultado: ${emb1 ? `Array[${emb1.length}]` : 'NULL/UNDEFINED'}`);
                if (emb1 && emb1.length > 0) {
                    log(outputId, `Primeiros valores: [${emb1.slice(0, 3).map(v => v.toFixed(4)).join(', ')}...]`);
                }
                
                // Teste 2: Texto m√©dio
                const text2 = "Este √© um teste de gera√ß√£o de embeddings para verificar se o sistema est√° funcionando corretamente.";
                log(outputId, `\nTeste 2: "${text2.substring(0, 50)}..."`);
                const emb2 = await KC.EmbeddingService.generateEmbedding(text2);
                log(outputId, `Resultado: ${emb2 ? `Array[${emb2.length}]` : 'NULL/UNDEFINED'}`);
                
                // Teste 3: Texto com caracteres especiais
                const text3 = "Teste com n√∫meros 123 e s√≠mbolos !@#$%";
                log(outputId, `\nTeste 3: "${text3}"`);
                const emb3 = await KC.EmbeddingService.generateEmbedding(text3);
                log(outputId, `Resultado: ${emb3 ? `Array[${emb3.length}]` : 'NULL/UNDEFINED'}`);
                
            } catch (error) {
                log(outputId, `ERRO: ${error.message}`, true);
                log(outputId, `Stack: ${error.stack}`, true);
            }
        }

        // 2. Teste com conte√∫do de arquivo
        async function testFileContent() {
            const outputId = 'file-output';
            document.getElementById(outputId).innerHTML = '';
            
            log(outputId, 'Carregando arquivos...');
            
            try {
                const files = KC.AppState.get('files') || [];
                const approved = files.filter(f => !f.archived && f.relevanceScore >= 50);
                
                if (approved.length === 0) {
                    log(outputId, 'Nenhum arquivo aprovado encontrado!', true);
                    return;
                }
                
                const testFile = approved[0];
                log(outputId, `Testando com arquivo: ${testFile.name}`);
                
                // Testa com preview
                if (testFile.preview) {
                    const previewText = Object.values(testFile.preview).join(' ').substring(0, 200);
                    log(outputId, `Preview: "${previewText}..."`);
                    
                    const embedding = await KC.EmbeddingService.generateEmbedding(previewText);
                    log(outputId, `Embedding do preview: ${embedding ? `Array[${embedding.length}]` : 'NULL/UNDEFINED'}`);
                }
                
                // Testa com conte√∫do
                if (testFile.content) {
                    const contentSnippet = testFile.content.substring(0, 200);
                    log(outputId, `\nConte√∫do: "${contentSnippet}..."`);
                    
                    const embedding = await KC.EmbeddingService.generateEmbedding(contentSnippet);
                    log(outputId, `Embedding do conte√∫do: ${embedding ? `Array[${embedding.length}]` : 'NULL/UNDEFINED'}`);
                }
                
            } catch (error) {
                log(outputId, `ERRO: ${error.message}`, true);
                log(outputId, `Stack: ${error.stack}`, true);
            }
        }

        // 3. Teste direto com Ollama
        async function testOllamaDirect() {
            const outputId = 'ollama-output';
            document.getElementById(outputId).innerHTML = '';
            
            log(outputId, 'Testando conex√£o direta com Ollama...');
            
            try {
                // Verifica se Ollama est√° rodando
                const healthResponse = await fetch('http://127.0.0.1:11434/api/tags');
                const healthData = await healthResponse.json();
                log(outputId, `Ollama status: ${healthResponse.ok ? 'ONLINE' : 'OFFLINE'}`);
                log(outputId, `Modelos dispon√≠veis: ${healthData.models?.map(m => m.name).join(', ') || 'Nenhum'}`);
                
                // Testa embedding diretamente
                log(outputId, '\nTestando gera√ß√£o de embedding...');
                const response = await fetch('http://127.0.0.1:11434/api/embeddings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'nomic-embed-text',
                        prompt: 'Este √© um teste direto de embedding'
                    })
                });
                
                const data = await response.json();
                log(outputId, `Response status: ${response.status}`);
                
                if (response.ok) {
                    log(outputId, `Embedding recebido: ${data.embedding ? `Array[${data.embedding.length}]` : 'N√£o encontrado'}`);
                    if (data.embedding) {
                        log(outputId, `Primeiros valores: [${data.embedding.slice(0, 3).map(v => v.toFixed(4)).join(', ')}...]`);
                    }
                } else {
                    log(outputId, `Erro: ${JSON.stringify(data)}`, true);
                }
                
            } catch (error) {
                log(outputId, `ERRO de conex√£o: ${error.message}`, true);
                log(outputId, 'Verifique se o Ollama est√° rodando com: ollama serve', true);
            }
        }

        // 4. Verificar configura√ß√£o
        async function checkServiceConfig() {
            const outputId = 'config-output';
            document.getElementById(outputId).innerHTML = '';
            
            log(outputId, 'Verificando configura√ß√£o do EmbeddingService...');
            
            try {
                // Configura√ß√£o atual
                log(outputId, `Configura√ß√£o:`, false);
                log(outputId, JSON.stringify(KC.EmbeddingService.config, null, 2));
                
                // Estat√≠sticas
                log(outputId, `\nEstat√≠sticas:`, false);
                log(outputId, JSON.stringify(KC.EmbeddingService.stats, null, 2));
                
                // Teste o m√©todo enrichTextWithContext
                const enriched = KC.EmbeddingService.enrichTextWithContext('teste', {category: 'test'});
                log(outputId, `\nTexto enriquecido: "${enriched}"`);
                
                // Teste cache key
                const cacheKey = KC.EmbeddingService.generateCacheKey('teste', {});
                log(outputId, `Cache key gerada: ${cacheKey}`);
                
            } catch (error) {
                log(outputId, `ERRO: ${error.message}`, true);
            }
        }
    </script>
</body>
</html>