<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Teste - Boost de Relev√¢ncia por Categoriza√ß√£o</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #2563eb; }
        h2 { color: #059669; margin-top: 0; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        .log {
            background: #f3f4f6;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .success { color: #059669; font-weight: bold; }
        .warning { color: #d97706; }
        .error { color: #dc2626; }
        .info { color: #3b82f6; }
        .boost { color: #7c3aed; font-weight: bold; }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th { background: #f9fafb; font-weight: 600; }
        .relevance-change {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .increased { background: #d1fae5; color: #065f46; }
        .formula {
            background: #ede9fe;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>üöÄ Teste de Boost de Relev√¢ncia por Categoriza√ß√£o</h1>
    
    <div class="section">
        <h2>üìê F√≥rmula do Boost</h2>
        <div class="formula">
            Boost = 1.5 + (n√∫mero_categorias √ó 0.1)
            
            Exemplos:
            ‚Ä¢ 1 categoria  = 1.6x (60% boost)
            ‚Ä¢ 2 categorias = 1.7x (70% boost) 
            ‚Ä¢ 3 categorias = 1.8x (80% boost)
            
            Nova_Relev√¢ncia = Min(100, Relev√¢ncia_Original √ó Boost)
        </div>
    </div>

    <div class="section">
        <h2>1Ô∏è‚É£ Criar Arquivos de Teste</h2>
        <button onclick="criarArquivosTeste()">Criar 5 Arquivos com Diferentes Relev√¢ncias</button>
        <div id="arquivos-criados" class="log" style="margin-top: 10px;"></div>
    </div>

    <div class="section">
        <h2>2Ô∏è‚É£ Aplicar Categorias e Ver Boost</h2>
        <button onclick="aplicarCategoriaUnica()">Aplicar 1 Categoria (60% boost)</button>
        <button onclick="aplicarDuasCategorias()">Aplicar 2 Categorias (70% boost)</button>
        <button onclick="aplicarTresCategorias()">Aplicar 3 Categorias (80% boost)</button>
        <button onclick="limparCategorias()">Limpar Todas as Categorias</button>
    </div>

    <div class="section">
        <h2>3Ô∏è‚É£ Tabela de Resultados</h2>
        <table id="tabela-resultados">
            <thead>
                <tr>
                    <th>Arquivo</th>
                    <th>Relev√¢ncia Original</th>
                    <th>Categorias</th>
                    <th>Boost Aplicado</th>
                    <th>Relev√¢ncia Final</th>
                    <th>Diferen√ßa</th>
                </tr>
            </thead>
            <tbody id="tbody-resultados">
                <tr><td colspan="6" style="text-align: center; color: #666;">Crie arquivos primeiro...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="section">
        <h2>4Ô∏è‚É£ Verificar no FileRenderer</h2>
        <button onclick="verificarFileRenderer()">Verificar Como FileRenderer Exibe</button>
        <button onclick="forcarRenderizacao()">For√ßar Re-renderiza√ß√£o</button>
        <div id="renderer-info" class="log" style="margin-top: 10px;"></div>
    </div>

    <div class="section">
        <h2>üìä Console de Debug</h2>
        <div id="console-log" class="log"></div>
    </div>

    <!-- Scripts do KC -->
    <script src="../js/core/EventBus.js"></script>
    <script src="../js/core/AppState.js"></script>
    <script src="../js/managers/CategoryManager.js"></script>
    <script src="../js/components/FileRenderer.js"></script>
    <script src="../js/utils/Logger.js"></script>

    <script>
        // IDs dos arquivos de teste
        let arquivosTeste = [];
        
        // Logger personalizado
        const logDiv = document.getElementById('console-log');
        function addLog(type, message) {
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<span class="${type}">[${time}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Inicializar KC
        KC.CategoryManager.initialize();
        
        // Criar categorias de teste se n√£o existirem
        if (KC.CategoryManager.getCategories().length === 0) {
            KC.CategoryManager.createCategory({ name: 'T√©cnico', color: '#3b82f6', icon: 'üîß' });
            KC.CategoryManager.createCategory({ name: 'Estrat√©gico', color: '#059669', icon: 'üéØ' });
            KC.CategoryManager.createCategory({ name: 'Insight', color: '#d97706', icon: 'üí°' });
        }
        
        addLog('success', 'Sistema KC inicializado com ' + KC.CategoryManager.getCategories().length + ' categorias');

        // Listener para mudan√ßas de arquivo
        KC.EventBus.on(KC.Events.FILES_UPDATED, (data) => {
            addLog('info', 'Evento FILES_UPDATED: ' + data.action);
            atualizarTabela();
        });

        function criarArquivosTeste() {
            arquivosTeste = [
                {
                    id: 'test-boost-1',
                    name: 'arquivo-baixa-relevancia.md',
                    relevanceScore: 20,
                    categories: [],
                    archived: false
                },
                {
                    id: 'test-boost-2',
                    name: 'arquivo-media-baixa.md',
                    relevanceScore: 40,
                    categories: [],
                    archived: false
                },
                {
                    id: 'test-boost-3',
                    name: 'arquivo-media.md',
                    relevanceScore: 50,
                    categories: [],
                    archived: false
                },
                {
                    id: 'test-boost-4',
                    name: 'arquivo-alta.md',
                    relevanceScore: 70,
                    categories: [],
                    archived: false
                },
                {
                    id: 'test-boost-5',
                    name: 'arquivo-muito-alta.md',
                    relevanceScore: 90,
                    categories: [],
                    archived: false
                }
            ];

            // Salva no AppState
            KC.AppState.set('files', arquivosTeste);

            document.getElementById('arquivos-criados').innerHTML = 
                '<span class="success">‚úÖ 5 arquivos criados com relev√¢ncias: 20%, 40%, 50%, 70%, 90%</span>';
            
            addLog('success', '5 arquivos de teste criados');
            atualizarTabela();
        }

        function aplicarCategoriaUnica() {
            const categorias = KC.CategoryManager.getCategories();
            if (categorias.length === 0) return;

            arquivosTeste.forEach(arquivo => {
                KC.CategoryManager.assignCategoryToFile(arquivo.id, categorias[0].id);
            });
            
            addLog('boost', '1 categoria aplicada - Boost esperado: 60%');
        }

        function aplicarDuasCategorias() {
            const categorias = KC.CategoryManager.getCategories();
            if (categorias.length < 2) return;

            arquivosTeste.forEach(arquivo => {
                KC.CategoryManager.assignCategoryToFile(arquivo.id, categorias[0].id);
                KC.CategoryManager.assignCategoryToFile(arquivo.id, categorias[1].id);
            });
            
            addLog('boost', '2 categorias aplicadas - Boost esperado: 70%');
        }

        function aplicarTresCategorias() {
            const categorias = KC.CategoryManager.getCategories();
            if (categorias.length < 3) return;

            arquivosTeste.forEach(arquivo => {
                KC.CategoryManager.assignCategoryToFile(arquivo.id, categorias[0].id);
                KC.CategoryManager.assignCategoryToFile(arquivo.id, categorias[1].id);
                KC.CategoryManager.assignCategoryToFile(arquivo.id, categorias[2].id);
            });
            
            addLog('boost', '3 categorias aplicadas - Boost esperado: 80%');
        }

        function limparCategorias() {
            arquivosTeste.forEach(arquivo => {
                arquivo.categories = [];
                arquivo.relevanceScore = arquivo.id.includes('1') ? 20 :
                                       arquivo.id.includes('2') ? 40 :
                                       arquivo.id.includes('3') ? 50 :
                                       arquivo.id.includes('4') ? 70 : 90;
            });
            
            KC.AppState.set('files', arquivosTeste);
            addLog('warning', 'Todas as categorias removidas - Relev√¢ncias restauradas');
            atualizarTabela();
        }

        function atualizarTabela() {
            const tbody = document.getElementById('tbody-resultados');
            const files = KC.AppState.get('files') || [];
            
            if (files.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">Nenhum arquivo encontrado</td></tr>';
                return;
            }

            tbody.innerHTML = files.map(file => {
                const originalScore = file.id.includes('1') ? 20 :
                                    file.id.includes('2') ? 40 :
                                    file.id.includes('3') ? 50 :
                                    file.id.includes('4') ? 70 : 90;
                
                const categorias = KC.CategoryManager.getCategories()
                    .filter(cat => file.categories?.includes(cat.id))
                    .map(cat => cat.name);
                
                const boost = file.categories?.length > 0 ? 
                    1.5 + (file.categories.length * 0.1) : 1;
                
                const diferenca = file.relevanceScore - originalScore;
                
                return `<tr>
                    <td>${file.name}</td>
                    <td>${originalScore}%</td>
                    <td>${categorias.join(', ') || '-'}</td>
                    <td>${boost}x</td>
                    <td><strong>${file.relevanceScore}%</strong></td>
                    <td class="relevance-change ${diferenca > 0 ? 'increased' : ''}">
                        ${diferenca > 0 ? '+' : ''}${diferenca}%
                    </td>
                </tr>`;
            }).join('');
        }

        function verificarFileRenderer() {
            const div = document.getElementById('renderer-info');
            const files = KC.AppState.get('files') || [];
            
            div.innerHTML = '<span class="info">Como FileRenderer calcula relev√¢ncia:</span>\n\n';
            
            files.forEach(file => {
                // Simula o c√°lculo do FileRenderer
                const relevanciaExibida = KC.FileRenderer.calculateRelevance(file);
                
                div.innerHTML += `${file.name}:\n`;
                div.innerHTML += `  file.relevanceScore = ${file.relevanceScore}%\n`;
                div.innerHTML += `  FileRenderer.calculateRelevance() = ${relevanciaExibida}%\n`;
                div.innerHTML += `  ${relevanciaExibida === file.relevanceScore ? '‚úÖ Correto!' : '‚ùå Diferente!'}\n\n`;
            });
            
            addLog('info', 'Verifica√ß√£o do FileRenderer conclu√≠da');
        }

        function forcarRenderizacao() {
            // For√ßa emiss√£o de evento
            const files = KC.AppState.get('files') || [];
            KC.EventBus.emit(KC.Events.STATE_CHANGED, {
                key: 'files',
                newValue: files,
                oldValue: files
            });
            
            addLog('info', 'Evento STATE_CHANGED emitido para for√ßar re-renderiza√ß√£o');
        }

        // Log inicial
        addLog('info', 'P√°gina de teste carregada. Clique em "Criar Arquivos" para come√ßar.');
    </script>
</body>
</html>