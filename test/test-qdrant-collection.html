<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Cole√ß√£o Qdrant</title>
    <link rel="stylesheet" href="../css/main.css">
    <style>
        body {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
        }
        .output {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        button {
            margin: 5px;
            padding: 10px 20px;
        }
        .success { color: var(--success-color); }
        .error { color: var(--danger-color); }
    </style>
</head>
<body>
    <h1>üîß Teste de Cole√ß√£o Qdrant</h1>
    
    <div class="test-section">
        <h2>1. Verificar/Criar Cole√ß√£o</h2>
        <button onclick="checkCollection()">Verificar Cole√ß√£o</button>
        <button onclick="createCollection()">Criar Cole√ß√£o</button>
        <div id="collection-output" class="output">Aguardando...</div>
    </div>

    <div class="test-section">
        <h2>2. Teste de Inser√ß√£o</h2>
        <button onclick="testInsert()">Inserir Ponto de Teste</button>
        <div id="insert-output" class="output">Aguardando...</div>
    </div>

    <div class="test-section">
        <h2>3. Listar Pontos</h2>
        <button onclick="listPoints()">Listar Pontos</button>
        <div id="list-output" class="output">Aguardando...</div>
    </div>

    <script src="../js/core/EventBus.js"></script>
    <script src="../js/core/AppState.js"></script>
    <script src="../js/core/Logger.js"></script>
    <script src="../js/services/QdrantService.js"></script>

    <script>
        const KC = window.KnowledgeConsolidator;
        const API_URL = 'http://qdr.vcia.com.br:6333';
        const COLLECTION = 'knowledge_consolidator';

        function log(elementId, message, className = '') {
            const output = document.getElementById(elementId);
            const time = new Date().toLocaleTimeString();
            output.innerHTML += `<span class="${className}">[${time}] ${message}</span>\n`;
        }

        async function checkCollection() {
            const outputId = 'collection-output';
            document.getElementById(outputId).innerHTML = '';
            
            try {
                log(outputId, 'Verificando cole√ß√£o...');
                
                const response = await fetch(`${API_URL}/collections/${COLLECTION}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(outputId, `Cole√ß√£o existe!`, 'success');
                    log(outputId, `Configura√ß√£o: ${JSON.stringify(data.result.config, null, 2)}`);
                    log(outputId, `Pontos: ${data.result.points_count || 0}`);
                } else if (response.status === 404) {
                    log(outputId, 'Cole√ß√£o n√£o existe!', 'error');
                    log(outputId, 'Clique em "Criar Cole√ß√£o" para criar');
                } else {
                    log(outputId, `Erro: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(outputId, `Erro de conex√£o: ${error.message}`, 'error');
            }
        }

        async function createCollection() {
            const outputId = 'collection-output';
            document.getElementById(outputId).innerHTML = '';
            
            try {
                log(outputId, 'Criando cole√ß√£o...');
                
                const response = await fetch(`${API_URL}/collections/${COLLECTION}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        vectors: {
                            size: 768,
                            distance: 'Cosine'
                        }
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log(outputId, 'Cole√ß√£o criada com sucesso!', 'success');
                    log(outputId, `Resposta: ${JSON.stringify(data, null, 2)}`);
                } else {
                    log(outputId, `Erro ao criar: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                log(outputId, `Erro: ${error.message}`, 'error');
            }
        }

        async function testInsert() {
            const outputId = 'insert-output';
            document.getElementById(outputId).innerHTML = '';
            
            try {
                log(outputId, 'Criando ponto de teste...');
                
                // Gera embedding aleat√≥rio de 768 dimens√µes
                const vector = new Array(768).fill(0).map(() => Math.random() * 2 - 1);
                
                const point = {
                    id: Date.now(),
                    vector: vector,
                    payload: {
                        test: true,
                        content: 'Ponto de teste criado via interface',
                        timestamp: new Date().toISOString()
                    }
                };
                
                log(outputId, `ID: ${point.id}`);
                log(outputId, 'Inserindo no Qdrant...');
                
                const result = await KC.QdrantService.insertBatch([point]);
                
                if (result.success) {
                    log(outputId, 'Inser√ß√£o bem-sucedida!', 'success');
                    log(outputId, `Pontos inseridos: ${result.pointsInserted}`);
                } else {
                    log(outputId, 'Erro na inser√ß√£o!', 'error');
                    log(outputId, JSON.stringify(result));
                }
            } catch (error) {
                log(outputId, `Erro: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function listPoints() {
            const outputId = 'list-output';
            document.getElementById(outputId).innerHTML = '';
            
            try {
                log(outputId, 'Listando pontos...');
                
                const response = await fetch(`${API_URL}/collections/${COLLECTION}/points/scroll`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        limit: 10,
                        with_payload: true,
                        with_vector: false
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(outputId, `Total de pontos: ${data.result?.points?.length || 0}`, 'success');
                    
                    if (data.result?.points) {
                        data.result.points.forEach(point => {
                            log(outputId, `\nID: ${point.id}`);
                            log(outputId, `Payload: ${JSON.stringify(point.payload, null, 2)}`);
                        });
                    }
                } else {
                    log(outputId, `Erro: ${response.status}`, 'error');
                }
            } catch (error) {
                log(outputId, `Erro: ${error.message}`, 'error');
            }
        }

        // Verifica ao carregar
        window.onload = () => {
            checkCollection();
        };
    </script>
</body>
</html>